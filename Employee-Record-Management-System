#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>

struct Employee {
    char id[50];
    char name[50];
    char department[50];
    char salary[100];
};

#define CSV_FILE "employees.csv"
#define TEMP_FILE "temp.csv"
#define LINE_MAX 512

static void trim_newline(char *s) {
    size_t n = strlen(s);
    while (n > 0 && (s[n-1] == '\n' || s[n-1] == '\r')) {
        s[n-1] = '\0';
        n--;
    }
}

static void read_line(char *buf, size_t size) {
    if (fgets(buf, (int)size, stdin) == NULL) {
        buf[0] = '\0';
        return;
    }
    trim_newline(buf);
}

int validate_name(const char *name) {
    for (int i = 0; name[i] != '\0'; i++) {
        if (!isalpha(name[i]) && name[i] != ' ')
            return 0;
    }
    return 1;
}

static void read_string(const char *prompt, char *out, size_t out_size) {
    while (1) {
        printf("%s", prompt);
        read_line(out, out_size);

        if (out[0] == '\0') {
            printf("Input cannot be empty. Please try again.\n");
            continue;
        }

        if (strstr(prompt, "Name") != NULL) {
            if (!validate_name(out)) {
                printf("Only letters and spaces allowed!\n");
                continue;
            }
        }

        break;
    }
}

double parse_salary(const char *input) {
    double base = 0.0;
    char unit = '\0';
    size_t len = strlen(input);

    if (isalpha(input[len - 1])) {
        unit = tolower(input[len - 1]);
        base = atof(input);
    } else {
        base = atof(input);
    }

    switch (unit) {
        case 'k': base *= 1000.0; break;
        case 'm': base *= 1000000.0; break;
        case 'b': base *= 1000000000.0; break;
        case 't': base *= 1000000000000.0; break;
        default: break;
    }

    return base;
}

int employeeExists(char *id) {
    FILE *fp = fopen(CSV_FILE, "r");
    if (!fp) return 0;

    char line[LINE_MAX];
    fgets(line, sizeof(line), fp);

    char cid[50], name[50], dept[50], salary[100];

    while (fgets(line, sizeof(line), fp)) {
        trim_newline(line);
        if (line[0] == '\0') continue;
        if (sscanf(line, "%49[^,],%49[^,],%49[^,],%99[^,]",
                   cid, name, dept, salary) == 4) {
            if (strcmp(cid, id) == 0) {
                fclose(fp);
                return 1;
            }
        }
    }

    fclose(fp);
    return 0;
}

void ensureHeader() {
    FILE *fp = fopen(CSV_FILE, "r");
    if (!fp) {
        fp = fopen(CSV_FILE, "w");
        fprintf(fp, "ID,Name,Department,Salary\n");
        fclose(fp);
        return;
    }
    fclose(fp);
}

void addanotherEmployee() {
    ensureHeader();
    struct Employee emp;

    read_string("Enter Employee ID: ", emp.id, sizeof(emp.id));

    if (employeeExists(emp.id)) {
        printf("Employee ID already exists!\n");
        return;
    }

    read_string("Enter Name: ", emp.name, sizeof(emp.name));
    read_string("Enter Department: ", emp.department, sizeof(emp.department));

    read_string("Enter Salary: ", emp.salary, sizeof(emp.salary));
    double val = parse_salary(emp.salary);
    sprintf(emp.salary, "%.2f", val);

    FILE *fp = fopen(CSV_FILE, "a");
    fprintf(fp, "%s,%s,%s,%s\n", emp.id, emp.name, emp.department, emp.salary);
    fclose(fp);

    printf("Employee added successfully.\n");
}

void readEmployees() {
    ensureHeader();
    FILE *fp = fopen(CSV_FILE, "r");
    if (!fp) {
        printf("Unable to open file!\n");
        return;
    }

    char line[LINE_MAX];

    printf("\n--- Employee Records ---\n");
    printf("ID\tName\tDepartment\tSalary\n");
    printf("-----------------------------------------------\n");

    fgets(line, sizeof(line), fp);

    while (fgets(line, sizeof(line), fp)) {
        trim_newline(line);

        if (line[0] == '\0') continue;
        if (strncmp(line, "ID,", 3) == 0) continue;

        char id[50], name[50], dept[50], salary[100];

        if (sscanf(line, "%49[^,],%49[^,],%49[^,],%99[^,]",
                   id, name, dept, salary) == 4) {
            printf("%s\t%s\t%s\t%s\n", id, name, dept, salary);
        }
    }

    fclose(fp);
}

void updateEmployee() {
    ensureHeader();

    char id[50];
    read_string("Enter Employee ID to update: ", id, sizeof(id));

    FILE *fp = fopen(CSV_FILE, "r");
    FILE *temp = fopen(TEMP_FILE, "w");

    char line[LINE_MAX];
    fgets(line, sizeof(line), fp);
    fprintf(temp, "%s", line);

    int found = 0;

    while (fgets(line, sizeof(line), fp)) {
        trim_newline(line);

        char cid[50], name[50], dept[50], salary[100];
        sscanf(line, "%49[^,],%49[^,],%49[^,],%99[^,]",
               cid, name, dept, salary);

        if (strcmp(cid, id) == 0) {
            found = 1;
            struct Employee emp;
            strcpy(emp.id, id);

            read_string("Enter new Name: ", emp.name, sizeof(emp.name));
            read_string("Enter new Department: ", emp.department, sizeof(emp.department));
            read_string("Enter new Salary: ", emp.salary, sizeof(emp.salary));

            double val = parse_salary(emp.salary);
            sprintf(emp.salary, "%.2f", val);

            fprintf(temp, "%s,%s,%s,%s\n",
                    emp.id, emp.name, emp.department, emp.salary);
        } else {
            fprintf(temp, "%s,%s,%s,%s\n",
                    cid, name, dept, salary);
        }
    }

    fclose(fp);
    fclose(temp);

    remove(CSV_FILE);
    rename(TEMP_FILE, CSV_FILE);

    if (found) printf("Record updated successfully.\n");
    else printf("Employee ID not found.\n");
}

void deleteEmployee() {
    ensureHeader();

    char id[50];
    read_string("Enter Employee ID to delete: ", id, sizeof(id));

    FILE *fp = fopen(CSV_FILE, "r");
    FILE *temp = fopen(TEMP_FILE, "w");

    char line[LINE_MAX];
    fgets(line, sizeof(line), fp);
    fprintf(temp, "%s", line);

    int found = 0;

    while (fgets(line, sizeof(line), fp)) {
        trim_newline(line);

        char cid[50], name[50], dept[50], salary[100];
        sscanf(line, "%49[^,],%49[^,],%49[^,],%99[^,]",
               cid, name, dept, salary);

        if (strcmp(cid, id) == 0) {
            found = 1;
            continue;
        }

        fprintf(temp, "%s,%s,%s,%s\n", cid, name, dept, salary);
    }

    fclose(fp);
    fclose(temp);

    remove(CSV_FILE);
    rename(TEMP_FILE, CSV_FILE);

    if (found) printf("Employee deleted successfully.\n");
    else printf("Employee ID not found.\n");
}

int main() {
    ensureHeader();
    int choice;

    while (1) {
        printf("\n===== Employee Record System =====\n");
        printf("1. Add Employee\n");
        printf("2. Display Employees\n");
        printf("3. Update Employee\n");
        printf("4. Delete Employee\n");
        printf("5. Exit\n");

        printf("Enter your choice: ");
        scanf("%d", &choice);
        getchar();

        switch (choice) {
            case 1: addanotherEmployee(); break;
            case 2: readEmployees(); break;
            case 3: updateEmployee(); break;
            case 4: deleteEmployee(); break;
            case 5: printf("Exiting...\n"); return 0;
            default: printf("Invalid choice!\n");
        }
    }

    return 0;
}
